---
title: åˆ†äº«ä¼šâ€”â€”graphqlè¡¥å……
date: 2021-07-06 21:30:07
permalink: /pages/3479e1/
categories:
  - å…¬å¸äº‹åŠ¡
---

# GraphQL

[toc]

GraphQL åªæ˜¯ä¸€ç§è§„èŒƒï¼Œ[å®˜ç½‘](https://graphql.org/code/) æä¾›äº†ä¸åŒå¹³å°çš„å…·ä½“å®ç°ï¼Œå®ƒçš„å®ç°åŒ…æ‹¬ï¼šæœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ã€ç›¸å…³å·¥å…·ã€‚

- æœåŠ¡ç«¯ï¼šGraphQL.jsï¼ˆå®˜ç½‘æä¾›çš„ js å®ç°ï¼‰ã€apollo-serverï¼ˆç¬¬ä¸‰æ–¹å®ç°ï¼ŒåŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼‰ã€express-graphqlï¼ˆGraphQL.js æ•´åˆåˆ° express æ¡†æ¶ï¼‰
- å®¢æˆ·ç«¯ï¼šapollo clientã€graphql-request ç­‰ç­‰ï¼Œä»–ä»¬åªæ˜¯å¯¹ ajax çš„å°è£…ï¼Œä½¿å¾—æ›´åŠ é€‚åˆ GraphQLï¼›

## ä½¿ç”¨

### æœåŠ¡ç«¯

- [GraphQL.js](https://graphql.org/graphql-js/) æœ€ç®€å•çš„ä½¿ç”¨åˆ†ä¸ºä¸‰æ­¥ï¼š

```js
const {graphql,buildSchema} = require('graphql')

// 1.æ„å»º schemaï¼šQueryï¼ˆæŸ¥è¯¢ï¼‰
const schema = buildSchema(`
    type Query {
        name:String,
        age:Int
    }
`)

// 2.å®šä¹‰ schema çš„ resolverï¼ˆæŸ¥è¯¢çš„æ—¶å€™å€¼æ˜¯ä»€ä¹ˆï¼‰
const root = {
    // æŸ¥è¯¢ name æ—¶ä¼šè°ƒç”¨å½“å‰å‡½æ•°ï¼Œè¿”å›å€¼å°±æ˜¯ç»“æœï¼ˆéœ€è¦ç¬¦åˆ schema ç±»å‹ï¼‰
    name(){
        return 'xm'
    },
    age(){
        return 12
    }
}

// 3.æŸ¥è¯¢ä½¿ç”¨
graphql(schema,'{name,age}',root).then(res=>{
    console.log(res.data.name,res.data.age) // xm 12
})
```

- [express ä½¿ç”¨](https://graphql.org/graphql-js/running-an-express-graphql-server/)ï¼š

```js
 const {graphql,buildSchema} = require('graphql')
const  express =require('express')
const {graphqlHTTP} = require('express-graphql')


// 1.æ„å»º schemaï¼šQueryï¼ˆæŸ¥è¯¢ï¼‰
const schema = buildSchema(`
    type Query {
        name:String,
        age:Int
    }
`)

// 2.å®šä¹‰ schema çš„ resolverï¼ˆæŸ¥è¯¢çš„æ—¶å€™å€¼æ˜¯ä»€ä¹ˆï¼‰
const root = {
    // æŸ¥è¯¢ name æ—¶ä¼šè°ƒç”¨å½“å‰å‡½æ•°ï¼Œè¿”å›å€¼å°±æ˜¯ç»“æœï¼ˆéœ€è¦ç¬¦åˆ schema ç±»å‹ï¼‰
    name(){
        return 'xm'
    },
    age(){
        return 12
    }
}

// 3.åˆ›å»º express å®ä¾‹ã€æŒ‚è½½ä¸­é—´ä»¶
const app = express()
app.use('/graphql',graphqlHTTP({
    schema,
    rootValue:root,
    graphiql:true //å¼€å¯ IDE å·¥å…·
}))
app.listen(3000)

//  æµè§ˆå™¨è¾“å…¥ï¼šhttp://localhost:3000/graphql
```

### å®¢æˆ·ç«¯

- index.html ï¼š

```js
<script src="./node_modules/axios/dist/axios.js"></script>
<script>
    axios({
        method:'POST', // è¯·æ±‚æ–¹æ³•å¿…é¡»æ˜¯ post
        url:'http://localhost:3000/graphql',
        data:{
            query: '{name,age}'
        }
    }).then(res=>{
        console.log(res.data.data)
    })
</script>
```

å¦å¤–åœ¨æœåŠ¡ç«¯ express çš„ä¾‹å­ä¸­åŠ ä¸Š ``cors``ï¼š

```js
const cors = require('cors')
.... balbala ....
app.use(cors()) // å…è®¸è·¨åŸŸ
.... balbala ....
```

## graphql æ ‡å‡†

æ¯ä¸ª graphql éƒ½ä¼šå®šä¹‰ä¸€å¥—ç±»å‹ç”¨äºæè¿°ä»æœåŠ¡å¯èƒ½æŸ¥è¯¢åˆ°çš„æ•°æ®ï¼Œæ¯å½“æŸ¥è¯¢åˆ°æ¥æœåŠ¡å™¨ä¼šæ ¹æ® schema å…ˆéªŒè¯å†æŸ¥è¯¢ã€‚

- Query ç±»å‹ï¼šä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡ç±»å‹ï¼Œæ˜¯æŸ¥è¯¢çš„å…¥å£ï¼Œå¦å¤– Query åªèƒ½å®šä¹‰ä¸€æ¬¡ï¼›

    ```js
    const schema = buildSchema(`
        ä¸èƒ½ä½œä¸ºæŸ¥è¯¢çš„å…¥å£
        type User{
            name:String
        }
        æŸ¥è¯¢çš„å…¥å£
        type Query {
            name:String,
            age:Int
        }
        Query åªèƒ½å®šä¹‰ä¸€æ¬¡
        type Query {
            name:String,
            age:Int
        }
    `)
    ```

- æ ‡é‡ç±»å‹ï¼ˆåŸºæœ¬ç±»å‹ï¼‰ï¼šIntï¼ˆ32 ä½æ•´æ•°ï¼‰ã€Floatï¼ˆåŒç²¾åº¦æµ®ç‚¹ï¼‰ã€Stringï¼ˆutf-8 å­—ç¬¦ä¸²ï¼‰ã€Booleanï¼ˆtrue/falseï¼‰ã€IDï¼ˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå­—ç¬¦ä¸²ï¼‰

- å¯¹è±¡ç±»å‹ï¼š

    ```js
    const schema = buildSchema(`
        type User{
            name:String,
            age:Int
        }
        type Query {
            user: User
        }
    `)
    const root = {
        user(){
            return {
                age: 12,
                name:'xm'
            }
        }
    }
    ```

- æ•°ç»„ç±»å‹ï¼š

    ```js
        const schema = buildSchema(`
            type User{
                name:String,
                age:Int,
                hobbies:[String]
            }
            type Query {
                user: User
            }
        `)
        const root = {
            user(){
                return {
                    age: 12,
                    name:'xm',
                    hobbies:['å”±','è·³','rap']
                }
            }
        }
    ```

- éç©ºç±»å‹ï¼šé»˜è®¤å¯ä»¥è¿”å› nullï¼Œå¦‚æœä¸èƒ½ä¸ºç©ºåœ¨åé¢åŠ  ``!``ï¼Œæ¯”å¦‚ ``name:String!,``ï¼Œ``hobbies:[String!]!`` è¡¨ç¤º hobbies ä¸èƒ½ä¸º nullï¼Œé‡Œé¢çš„å…ƒç´ ä¹Ÿä¸èƒ½ä¸º nullï¼ˆå¯ä»¥è¿”å› []ï¼‰ï¼›

## ç¤ºä¾‹

### æœåŠ¡ç«¯ CRUD

- æŸ¥è¯¢ï¼š

```js
const students = [
    { id: '1', name: 'xm', age: 13, hobbies: ['ç”»ç”»', 'è¯»ä¹¦'] },
    { id: '2', name: 'cxk', age: 15, hobbies: ['å”±', 'è·³', 'rap'] }
]

const schema = buildSchema(`
    type Student{
        id:ID!
        name:String!
        hobbies:[String!]!
    }
    type Query {
        students:[Student]
        student(id:ID!):Student
    }
`)
const root = {
    // æŸ¥è¯¢æ‰€æœ‰
    students(){
        return students
    },
    // æŸ¥è¯¢å•ä¸ª
    student({id}){
        return students.find(item=>item.id === id)
    }
}

```

![graphql-1](https://gitee.com/liuxingtian/markdow/raw/master/03.å…¬å¸äº‹åŠ¡/images/graphql/graphql-1.png)

- æ·»åŠ ï¼š

```js
    const {v4:uuidv4} = require('uuid')
    const students = [
        { id: '1', name: 'xm', age: 13, hobbies: ['ç”»ç”»', 'è¯»ä¹¦'] },
        { id: '2', name: 'cxk', age: 15, hobbies: ['å”±', 'è·³', 'rap'] }
    ]
    // è¾“å…¥å‚æ•°å¿…é¡»é€šè¿‡ input å®šä¹‰
    const schema = buildSchema(`
        input InputStu{
            name:String!
            age:Int!
            hobbies:[String!]
        }
        type Mutation {
            create(inputStu:InputStu):Student!
        }
    `)
    const root = {
        // æ–°å¢
        create({inputStu}){
            inputStu.id = uuidv4()
            students.push(inputStu)
            return inputStu
        }
    }
```

- ä¿®æ”¹ï¼š

```js
const students = [
    { id: '1', name: 'xm', age: 13, hobbies: ['ç”»ç”»', 'è¯»ä¹¦'] },
    { id: '2', name: 'cxk', age: 15, hobbies: ['å”±', 'è·³', 'rap'] }
]
const schema = buildSchema(`
    input UpdateStuInput{
        name:String!
        age:Int!
    }
    type Mutation {
        update(id:ID!,stu:UpdateStuInput):Student
    }
`)
const root = {
    // ä¿®æ”¹
    update({id,stu}){
        const student = students.find(student => student.id === id)
        if(student){
            student.name = stu.name
            student.age = stu.age
        }
        return student
    }
}
```

- åˆ é™¤ï¼š

```js
    const {v4:uuidv4} = require('uuid')
    const students = [
        { id: '1', name: 'xm', age: 13, hobbies: ['ç”»ç”»', 'è¯»ä¹¦'] },
        { id: '2', name: 'cxk', age: 15, hobbies: ['å”±', 'è·³', 'rap'] }
    ]

    const schema = buildSchema(`
        type DeletionStatus{
            success: Boolean
        }
        type Mutation {
            create(inputStu:InputStu):Student!
            update(id:ID!,stu:UpdateStuInput):Student
            del(id:ID!):DeletionStatus
        }
    `)
    const root = {
        // åˆ é™¤
        del({id}){
            const idnex = students.findIndex(student => student.id === id)
            students.splice(idnex,1)
            return {
                success:true
            }
        }
    }
```

- æœ€ç»ˆä»£ç ï¼š

```js
const {buildSchema } = require('graphql')
const express = require('express')
const { graphqlHTTP } = require('express-graphql')
const {v4:uuidv4} = require('uuid')
const cors = require('cors')

const students = [
    { id: '1', name: 'xm', age: 13, hobbies: ['ç”»ç”»', 'è¯»ä¹¦'] },
    { id: '2', name: 'cxk', age: 15, hobbies: ['å”±', 'è·³', 'rap'] }
]
const schema = buildSchema(`
    type Student{
        id:ID!
        name:String!
        hobbies:[String!]!
    }
    type Query {
        students:[Student]
        student(id:ID!):Student
    }
    input InputStu{
        name:String!
        age:Int!
        hobbies:[String!]
    }
    input UpdateStuInput{
        name:String!
        age:Int!
    }
    type DeletionStatus{
        success: Boolean
    }
    type Mutation {
        create(inputStu:InputStu):Student!
        update(id:ID!,stu:UpdateStuInput):Student
        del(id:ID!):DeletionStatus
    }
`)
const root = {
    // æŸ¥è¯¢æ‰€æœ‰
    students(){
        return students
    },
    // æŸ¥è¯¢å•ä¸ª
    student({id}){
        return students.find(item=>item.id === id)
    },
    // æ–°å¢
    create({inputStu}){
       inputStu.id = uuidv4()
       students.push(inputStu)
       return inputStu
    },
    // ä¿®æ”¹
    update({id,stu}){
        const student = students.find(student => student.id === id)
        if(student){
            student.name = stu.name
            student.age = stu.age
        }
        return student
    },
    // åˆ é™¤
    del({id}){
        const idnex = students.findIndex(student => student.id === id)
        students.splice(idnex,1)
        return {
            success:true
        }
    }
}

const app = express()
app.use(cors())
app.use('/graphql', graphqlHTTP({
    schema,
    rootValue: root,
    graphiql: true
}))
app.listen(3000)

```

### axios è¯·æ±‚

post è¯·æ±‚ï¼Œgraphql  æ“ä½œéƒ½å†™åœ¨è¯·æ±‚çš„ ``data:{query:æ“ä½œ}`` ä¸­ï¼Œå¦‚æœæœ‰å‚æ•°ä¸ç”¨è‡ªå·±æ‹¼æ¥ï¼Œå¯ä»¥å†™åœ¨ ``data:{variables:å‚æ•°}`` ä¸­ã€‚

```html
 <script src="./node_modules/axios/dist/axios.js"></script>
    <script>
        async function request (data){
            let res = await axios({
                method:'POST', // è¯·æ±‚æ–¹æ³•å¿…é¡»æ˜¯ post
                url:'http://localhost:3000/graphql',
                data
            })
            return res.data.data
        }

        // request({query:`
        //   query getStudents {
        //         students{
        //            name,
        //            age,
        //            hobbies
        //         }
        //    }
        // `})

        // let id = '1'
        // request({query:`
        //   query getStudent{
        //         student(id:${id}){
        //             id,
        //            name,
        //            age,
        //            hobbies
        //         }
        //    }
        // `})

        // æœåŠ¡ç«¯è‡ªåŠ¨è§£æ
        // request({
        //     query:`
        //         query getStudent($stuId:ID!){
        //                 student(id:$stuId){
        //                     id,
        //                     name,
        //                     age,
        //                     hobbies
        //                 }
        //         }
        //         `,
        //     variables: {
        //         stuId:1
        //     }
        // })

        // request({
        //     query:`
        //         mutation createStu($stu:InputStu!){
        //             create(inputStu:$stu){
        //                 id,
        //                 name,
        //                 age,
        //                 hobbies
        //             }
        //         }
        //         `,
        //     variables: {
        //         stu:{
        //             name:'å¼ ä¸‰',
        //             age:88,
        //             hobbies:[]
        //         }
        //     }
        // })

        // request({
        //     query:`
        //         mutation updateStu($id:ID!,$stu:UpdateStuInput!){
        //             update(stu:$stu,id:$id){
        //                 id,
        //                 name,
        //                 age,
        //                 hobbies
        //             }
        //         }
        //         `,
        //     variables: {
        //         stu:{
        //             name:'å¼ ä¸‰',
        //             age:88
        //         },
        //         id: '1'
        //     }
        // })
        request({
            query:`
                mutation deleteStu($id:ID!){
                    del(id:$id){
                        success
                    }
                }
                `,
            variables: {
                id: '1'
            }
        })
    </script>

```

### apollo

[Apollo](https://www.apollographql.com/docs/intro/platform/) æä¾›äº†ç¬¦åˆ GraphQL è§„èŒƒçš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œå¯ä»¥å¿«æ·å®Œæˆ GraphQL å¼€å‘ã€‚

```js
const { ApolloServer, gql } = require('apollo-server')
// å¯ä»¥å®‰è£… Apollo GraphQL æ’ä»¶ç”¨äºè¯­æ³•é«˜äº®
const typeDefs = gql`
    type User {
        name: String
        age: Int
    }
    type Query {
        user:User
    }
`
const user = {
    name: 'å°æ˜',
    age: 13
}
const resolvers = {
    // æ‰€æœ‰ query å…¥å£
    Query: {
        user: () => user
    }
}
const server = new ApolloServer({ typeDefs, resolvers })
server.listen().then(({ url }) => {
    console.log(`ğŸš€  Server ready at ${url}`)
})
```

å¯ä»¥ä½¿ç”¨ [middleware](https://www.apollographql.com/docs/apollo-server/v2/integrations/middleware/) é›†æˆåˆ°å…¶å®ƒæ¡†æ¶ã€‚

å¦‚æœéœ€è¦è¿æ¥ rest/db ç­‰ç­‰æ•°æ®æºï¼Œå¯ä»¥åœ¨ npm æœç´¢ ``apollo datasource``
